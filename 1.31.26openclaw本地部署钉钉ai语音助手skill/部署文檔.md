# OpenClaw 钉钉机器人部署指南-AGI_Ananas

## 一、部署 OpenClaw

### 1.1 环境准备

```bash
# 确保 Node.js v22+
node -v  # 如果版本低，使用 nvm 升级
nvm install 22
nvm use 22

# 安装 pnpm
npm install -g pnpm

# 安装系统依赖（语音功能需要）
sudo apt install -y python3-pip ffmpeg
sudo pip install edge-tts requests --break-system-packages
```

### 1.2 克隆并构建

```bash
cd /media/cosmic-1/00video
git clone https://github.com/openclaw/openclaw.git
cd openclaw

pnpm install
pnpm ui:build
pnpm build
```

### 1.3 初始化配置

```bash
pnpm openclaw onboard
```

按提示完成：
- 选择模型提供商（如 Qwen Portal）
- 完成 OAuth 登录
- 设置工作目录（如 `/home/wang/clawd`）

---

## 二、钉钉开发者平台配置

### 2.1 创建应用

1. 访问 [钉钉开发者后台](https://open-dev.dingtalk.com/)
2. 点击「创建应用」→「企业内部应用」
3. 填写应用名称和描述

### 2.2 添加机器人能力

1. 进入应用详情页
2. 点击「添加应用能力」→「机器人」
3. 配置机器人基本信息

### 2.3 配置 Stream 模式（重要！）

1. 在机器人配置页面，找到「消息接收模式」
2. **选择 Stream 模式**（不是 HTTP 模式）
3. 保存配置

### 2.4 获取凭证

在「凭证与基础信息」页面获取：

| 参数 | 说明 |
|------|------|
| Client ID (AppKey) | 应用唯一标识 |
| Client Secret (AppSecret) | 应用密钥 |

### 2.5 发布应用

1. 点击「版本管理与发布」
2. 创建新版本并发布
3. 确保应用状态为「已发布」

---

## 三、安装钉钉插件

### 3.1 安装插件

```bash
pnpm openclaw plugins install https://github.com/adoresever/openclaw-diding.git
```

### 3.2 配置凭证

编辑 `~/.openclaw/openclaw.json`，添加 `channels.dingtalk`：

**修改前：**
```json
  "messages": {
    "ackReactionScope": "group-mentions"
  }
}
```

**修改后：**
```json
  "messages": {
    "ackReactionScope": "group-mentions"
  },
  "channels": {
    "dingtalk": {
      "enabled": true,
      "clientId": "你的AppKey",
      "clientSecret": "你的AppSecret",
      "dmPolicy": "open",
      "groupPolicy": "open",
      "requireMention": true
    }
  }
}
```

**配置参数说明：**

| 参数 | 说明 |
|------|------|
| `clientId` | 钉钉 AppKey |
| `clientSecret` | 钉钉 AppSecret |
| `dmPolicy` | 私聊策略：`open`/`pairing`/`allowlist` |
| `groupPolicy` | 群聊策略：`open`/`allowlist`/`disabled` |
| `requireMention` | 群聊是否需要 @机器人 |

---

## 四、启动并验证

### 4.1 启动 Gateway

```bash
cd /media/cosmic-1/00video/openclaw
pnpm openclaw gateway --verbose
```

### 4.2 验证连接

看到以下日志表示连接成功：

```
[dingtalk] starting Stream connection for account default...
[dingtalk] Stream client connected
```

### 4.3 测试消息

- **私聊**：在钉钉中找到机器人，直接发消息
- **群聊**：在群里 @机器人名称 + 消息内容

---

## 五、部署语音播报 Skill

### 5.1 创建 Skill 目录

```bash
mkdir -p ~/clawd/skills/dingtalk-audio
```

### 5.2 创建语音脚本

创建 `~/clawd/skills/dingtalk-audio/send_audio.py`：

```python
#!/usr/bin/env python3
"""钉钉语音播报"""
import subprocess, requests, os, json, sys

# 替换为你的凭证
APPKEY = "你的AppKey"
APPSECRET = "你的AppSecret"
OPEN_CONVERSATION_ID = "你的群ChatID"  # 从群设置获取

def main():
    text = sys.argv[1] if len(sys.argv) > 1 else "测试语音"
    mp3 = '/tmp/dingtalk_audio.mp3'
    
    # 1. 生成语音
    subprocess.run(['edge-tts', '--text', text, '--voice', 'zh-CN-XiaoxiaoNeural', '--write-media', mp3], check=True, capture_output=True)
    
    # 2. 获取时长
    result = subprocess.run(['ffprobe', '-v', 'quiet', '-show_entries', 'format=duration', '-of', 'default=noprint_wrappers=1:nokey=1', mp3], capture_output=True, text=True)
    duration = int(float(result.stdout.strip()) * 1000)
    
    # 3. 获取 token
    token = requests.get(f'https://oapi.dingtalk.com/gettoken?appkey={APPKEY}&appsecret={APPSECRET}').json()['access_token']
    
    # 4. 上传音频
    with open(mp3, 'rb') as f:
        resp = requests.post(f'https://oapi.dingtalk.com/media/upload?access_token={token}&type=voice', files={'media': ('voice.mp3', f, 'audio/mpeg')}).json()
    
    media_id = resp.get('media_id')
    if not media_id:
        print(f"上传失败: {resp}")
        return
    
    # 5. 发送语音
    resp = requests.post(
        'https://api.dingtalk.com/v1.0/robot/groupMessages/send',
        headers={'x-acs-dingtalk-access-token': token},
        json={
            "robotCode": APPKEY,
            "openConversationId": OPEN_CONVERSATION_ID,
            "msgKey": "sampleAudio",
            "msgParam": json.dumps({"mediaId": media_id, "duration": str(duration)})
        }
    ).json()
    
    if resp.get('processQueryKey'):
        print("✅ 语音发送成功")
    else:
        print(f"发送结果: {resp}")
    
    os.path.exists(mp3) and os.remove(mp3)

if __name__ == "__main__":
    main()
```

### 5.3 创建 Skill 说明

创建 `~/clawd/skills/dingtalk-audio/SKILL.md`：

```markdown
# 钉钉语音播报

将文本转换为语音并发送到钉钉群。

## 触发条件
用户说"用语音说"、"语音播报"、"读出来"、"发语音"

## 命令
python3 /home/wang/clawd/skills/dingtalk-audio/send_audio.py "要播报的内容"

## 示例
用户: "用语音说 你好"
执行: python3 /home/wang/clawd/skills/dingtalk-audio/send_audio.py "你好"
```

### 5.4 测试语音功能

```bash
python3 ~/clawd/skills/dingtalk-audio/send_audio.py "测试语音播报"
```

钉钉群应收到可播放的语音消息。

---

## 六、常用命令

```bash
# 启动
pnpm openclaw gateway --verbose

# 停止
pnpm openclaw gateway stop

# 查看日志
tail -f /tmp/openclaw/openclaw-$(date +%Y-%m-%d).log

# 手动发送语音
python3 ~/clawd/skills/dingtalk-audio/send_audio.py "你好"

# 修复配置
pnpm openclaw doctor --fix
```

---

## 七、关键路径

| 用途 | 路径 |
|------|------|
| 项目源码 | `/media/cosmic-1/00video/openclaw` |
| 配置文件 | `~/.openclaw/openclaw.json` |
| 工作目录 | `~/clawd` |
| Skills | `~/clawd/skills/` |
| 语音脚本 | `~/clawd/skills/dingtalk-audio/send_audio.py` |

---

## 八、故障排除

| 问题 | 解决方案 |
|------|---------|
| 收不到消息 | 确认应用已发布，消息模式是 Stream |
| 群消息无响应 | 确认正确 @机器人，机器人已加入群 |
| 连接失败 | 检查 clientId/clientSecret 是否正确 |
| 语音发送失败 | 检查 OPEN_CONVERSATION_ID 是否正确 |
